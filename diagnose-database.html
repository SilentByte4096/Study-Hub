<!DOCTYPE html>
<html>
<head>
    <title>StudyHub Database Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
    </style>
</head>
<body>
    <h1>üîç StudyHub Database Diagnostic</h1>
    
    <div class="test info">
        <h3>Step 1: Run Comprehensive Tests</h3>
        <button class="btn-primary" onclick="runAllTests()">üß™ Run All Diagnostic Tests</button>
    </div>

    <div id="results"></div>

    <div class="test warning">
        <h3>Step 2: Database Fixes (If Needed)</h3>
        <p>If tests show missing tables or RLS issues, you need to run these SQL commands in your Supabase dashboard:</p>
        <button class="btn-success" onclick="showQuickFix()">üìã Show Quick Fix SQL</button>
        <button class="btn-danger" onclick="showFullMigration()">üìÇ Show Full Migration</button>
    </div>

    <div id="fixes" style="display: none;"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    
    <script>
        async function runAllTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>üîÑ Running diagnostics...</h3>';
            
            let results = [];
            
            // Test 1: Supabase Connection
            results.push(await testSupabaseConnection());
            
            // Test 2: Authentication
            results.push(await testAuthentication());
            
            // Test 3: Database Tables
            results.push(await testDatabaseTables());
            
            // Test 4: User Profile
            results.push(await testUserProfile());
            
            // Test 5: RLS Policies
            results.push(await testRLSPolicies());
            
            resultsDiv.innerHTML = results.join('');
        }

        async function testSupabaseConnection() {
            try {
                if (!window.supabase) {
                    return '<div class="test error"><h4>‚ùå Supabase Not Initialized</h4><p>Supabase client failed to load. Check your configuration.</p></div>';
                }
                
                const { data, error } = await window.supabase.from('profiles').select('count').limit(1);
                
                if (error) {
                    return `<div class="test error"><h4>‚ùå Database Connection Failed</h4><p>Error: ${error.message}</p></div>`;
                }
                
                return '<div class="test success"><h4>‚úÖ Supabase Connection</h4><p>Successfully connected to database</p></div>';
            } catch (err) {
                return `<div class="test error"><h4>‚ùå Connection Error</h4><p>${err.message}</p></div>`;
            }
        }

        async function testAuthentication() {
            try {
                const { data: { user }, error } = await window.supabase.auth.getUser();
                
                if (error) {
                    return `<div class="test warning"><h4>‚ö†Ô∏è Auth Check Failed</h4><p>Error: ${error.message}</p></div>`;
                }
                
                if (user) {
                    return `<div class="test success"><h4>‚úÖ User Authenticated</h4><p>Logged in as: ${user.email}</p></div>`;
                } else {
                    return '<div class="test info"><h4>‚ÑπÔ∏è Not Logged In</h4><p>No user currently authenticated</p></div>';
                }
            } catch (err) {
                return `<div class="test error"><h4>‚ùå Auth Error</h4><p>${err.message}</p></div>`;
            }
        }

        async function testDatabaseTables() {
            const tables = ['profiles', 'classes', 'assignments', 'resources', 'class_enrollments'];
            let results = '<div class="test info"><h4>üìä Database Tables Test</h4>';
            
            for (const table of tables) {
                try {
                    const { data, error } = await window.supabase.from(table).select('*').limit(1);
                    
                    if (error) {
                        results += `<p>‚ùå ${table}: ${error.message}</p>`;
                    } else {
                        results += `<p>‚úÖ ${table}: Accessible</p>`;
                    }
                } catch (err) {
                    results += `<p>‚ùå ${table}: ${err.message}</p>`;
                }
            }
            
            return results + '</div>';
        }

        async function testUserProfile() {
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                
                if (!user) {
                    return '<div class="test info"><h4>‚ÑπÔ∏è Profile Test Skipped</h4><p>Not logged in</p></div>';
                }
                
                const { data: profile, error } = await window.supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    return `<div class="test error"><h4>‚ùå Profile Missing</h4><p>Error: ${error.message}</p><p><strong>This is likely your main issue!</strong></p></div>`;
                }
                
                return `<div class="test success"><h4>‚úÖ Profile Found</h4><p>Name: ${profile.full_name}, Role: ${profile.role}</p></div>`;
            } catch (err) {
                return `<div class="test error"><h4>‚ùå Profile Test Failed</h4><p>${err.message}</p></div>`;
            }
        }

        async function testRLSPolicies() {
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                
                if (!user) {
                    return '<div class="test info"><h4>‚ÑπÔ∏è RLS Test Skipped</h4><p>Not logged in</p></div>';
                }
                
                // Test creating a class (this is what's failing)
                const { data, error } = await window.supabase
                    .from('classes')
                    .insert([{
                        teacher_id: user.id,
                        name: 'Test Class - DELETE ME',
                        subject: 'Test',
                        description: 'Test class for diagnostic',
                        class_code: 'TEST123'
                    }])
                    .select();
                
                if (error) {
                    return `<div class="test error"><h4>‚ùå Class Creation Failed</h4><p>Error: ${error.message}</p><p><strong>This is your "Failed to create class" error!</strong></p></div>`;
                }
                
                // Clean up test class
                if (data && data[0]) {
                    await window.supabase.from('classes').delete().eq('id', data[0].id);
                }
                
                return '<div class="test success"><h4>‚úÖ RLS Policies Working</h4><p>Can create classes successfully</p></div>';
            } catch (err) {
                return `<div class="test error"><h4>‚ùå RLS Test Failed</h4><p>${err.message}</p></div>`;
            }
        }

        function showQuickFix() {
            const fixesDiv = document.getElementById('fixes');
            fixesDiv.style.display = 'block';
            fixesDiv.innerHTML = `
                <div class="test warning">
                    <h4>üöÄ Quick Fix SQL Commands</h4>
                    <p>Copy and paste these commands into your Supabase Dashboard ‚Üí SQL Editor:</p>
                    <pre>-- 1. Create missing user profiles
INSERT INTO profiles (id, full_name, email, role)
SELECT 
    au.id,
    COALESCE(au.raw_user_meta_data->>'full_name', 'User') as full_name,
    au.email,
    COALESCE(au.raw_user_meta_data->>'role', 'student') as role
FROM auth.users au
WHERE au.id NOT IN (SELECT id FROM profiles)
ON CONFLICT (id) DO NOTHING;

-- 2. Add missing INSERT policy for profiles
CREATE POLICY "Users can insert own profile"
    ON profiles FOR INSERT
    TO authenticated
    WITH CHECK (auth.uid() = id);

-- 3. Enable classes table for teachers
CREATE POLICY "Teachers can manage their classes"
    ON classes FOR ALL
    TO authenticated
    USING (teacher_id = auth.uid());</pre>
                    <p><strong>After running these, refresh the page and test again.</strong></p>
                </div>
            `;
        }

        function showFullMigration() {
            const fixesDiv = document.getElementById('fixes');
            fixesDiv.style.display = 'block';
            fixesDiv.innerHTML = `
                <div class="test info">
                    <h4>üìÇ Full Database Migration</h4>
                    <p>Run the complete migration files in this order:</p>
                    <ol>
                        <li><strong>supabase/migrations/20250901145820_jade_term.sql</strong> - Main schema</li>
                        <li><strong>supabase/migrations/20250902_additional_fixes.sql</strong> - Profile fixes</li>
                        <li><strong>supabase/migrations/20250902_fix_rls_policies.sql</strong> - RLS policies</li>
                    </ol>
                    <p>Go to your Supabase Dashboard ‚Üí SQL Editor ‚Üí Copy and paste each file's contents ‚Üí Run</p>
                </div>
            `;
        }

        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>